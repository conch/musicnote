<%
dir = File.expand_path(File.dirname(__FILE__))
$LOAD_PATH.push("#{dir}/..")
$LOAD_PATH.push("#{dir}/../evernote")
$LOAD_PATH.push("#{dir}/../evernote/Evernote/EDAM")

require "auth_secrets.rb"
require "json"
require "thrift/types"
require "thrift/struct"
require "thrift/protocol/base_protocol"
require "thrift/protocol/binary_protocol"
require "thrift/transport/base_transport"
require "thrift/transport/http_client_transport"
require "Evernote/EDAM/user_store"
require "Evernote/EDAM/user_store_constants.rb"
require "Evernote/EDAM/note_store"
require "Evernote/EDAM/limits_constants.rb"

consumerKey = CKEY
consumerSecret = CSECRET
username = u
password = p

evernoteHost = "sandbox.evernote.com"
userStoreUrl = "https://#{evernoteHost}/edam/user"
noteStoreUrlBase = "https://#{evernoteHost}/edam/note/"

userStoreTransport = Thrift::HTTPClientTransport.new(userStoreUrl)
userStoreProtocol = Thrift::BinaryProtocol.new(userStoreTransport)
userStore = Evernote::EDAM::UserStore::UserStore::Client.new(userStoreProtocol)

authResult = userStore.authenticate(username, password, consumerKey, consumerSecret)
user = authResult.user
authToken = authResult.authenticationToken

noteStoreUrl = noteStoreUrlBase + user.shardId
noteStoreTransport = Thrift::HTTPClientTransport.new(noteStoreUrl)
noteStoreProtocol = Thrift::BinaryProtocol.new(noteStoreTransport)
noteStore = Evernote::EDAM::NoteStore::NoteStore::Client.new(noteStoreProtocol)

notebooks = noteStore.listNotebooks(authToken)
# notebookNames = {}
# notebooks.each do |book|
#   name = book.name
#   if book.defaultNotebook
#     name += " (default)"
#   end
#   notebookNames[name] = book.guid
# end
notebookNames = notebooks.map do |book|
  name = book.name
  if book.defaultNotebook
    name += " (default)"
  end
  [name, book.guid]
end
%>

<%= notebookNames.sort.to_json %>